<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market News - Stock Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            500: '#8b5cf6',
                            600: '#7c3aed'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <div class="flex flex-1">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 min-h-screen p-6">
            <!-- Logo/Title -->
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-white">Stock Analytics</h1>
            </div>
            
            <!-- User Info -->
            <div class="mb-8 text-center">
                {% if user_name %}
                    <p class="text-gray-300 text-lg font-semibold mb-2">Welcome, {{ user_name }}!</p>
                    <a href="{{ url_for('logout') }}" 
                       class="inline-block bg-red-600 hover:bg-red-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                        Logout
                    </a>
                {% else %}
                    <a href="{{ url_for('login') }}" 
                       class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                        Login
                    </a>
                {% endif %}
            </div>

            <!-- Navigation Menu -->
            <nav class="space-y-4">
                <a href="{{ url_for('index') }}" class="block text-gray-300 hover:text-white hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">
                    üè† Dashboard
                </a>
                <a href="#" class="block w-full bg-primary-500 text-white px-4 py-3 rounded-lg font-medium">
                    üì∞ Market News
                </a>
                <a href="{{ url_for('recommendations_page') }}" class="block text-gray-300 hover:text-white hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">
                    üìà Stock Recommendations
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 p-8">
            <!-- Header Section -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">Market News</h1>
                <p class="text-gray-400 text-lg">Stay updated with the latest financial news and market insights</p>
            </div>

            <!-- News Filters -->
            <div class="bg-gray-800 rounded-2xl shadow-lg p-6 mb-8 border border-gray-700">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex-1 min-w-64">
                        <label for="symbol-filter" class="block text-sm font-medium text-gray-300 mb-2">
                            Filter by Stock Symbol (Optional)
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="symbol-filter"
                                class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all text-white placeholder-gray-400"
                                placeholder="e.g., AAPL, TSLA, MSFT, RELIANCE.NS"
                            >
                            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            id="filter-btn"
                            class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                            Filter News
                        </button>
                        <button 
                            id="clear-filter-btn"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-colors"
                        >
                            Show All
                        </button>
                        <button 
                            id="refresh-btn"
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"></div>
                <p class="text-gray-400 mt-4">Loading latest market news...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden bg-red-900 border border-red-700 rounded-xl p-6 text-center">
                <svg class="w-12 h-12 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-red-400 mb-2">Error Loading News</h3>
                <p class="text-red-300" id="error-message">Unable to fetch the latest news. Please try again later.</p>
            </div>

            <!-- News Articles Container -->
            <div id="news-container" class="hidden space-y-6">
                <!-- News articles will be dynamically inserted here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden text-center py-12">
                <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                </svg>
                <h3 class="text-xl font-semibold text-gray-400 mb-2">No News Found</h3>
                <p class="text-gray-500">No articles found for the selected symbol. Try a different search term.</p>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 border-t border-gray-700 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm">
                &copy; 2024 Stock Analytics. Market news powered by Finnhub API.
            </p>
        </div>
    </footer>

    <script>
        let currentSymbol = null;
        
        // DOM Elements
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const newsContainer = document.getElementById('news-container');
        const emptyState = document.getElementById('empty-state');
        const symbolFilter = document.getElementById('symbol-filter');
        const filterBtn = document.getElementById('filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const errorMessage = document.getElementById('error-message');

        // Show/hide states
        function showState(state) {
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            newsContainer.classList.add('hidden');
            emptyState.classList.add('hidden');
            
            state.classList.remove('hidden');
        }

        // Format date
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Truncate text
        function truncateText(text, maxLength = 150) {
            if (!text || text.length <= maxLength) return text || '';
            return text.substring(0, maxLength) + '...';
        }

        // Create news article HTML
        function createNewsArticle(article) {
            const imageHtml = article.image ? 
                `<img src="${article.image}" alt="News image" class="w-full h-48 object-cover rounded-lg mb-4" onerror="this.style.display='none'">` : '';
            
            const sourceHtml = article.source ? 
                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary-900 text-primary-300">
                    ${article.source}
                </span>` : '';

            return `
                <article class="bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-700 hover:border-gray-600 transition-colors">
                    ${imageHtml}
                    <div class="flex items-center gap-3 mb-3">
                        ${sourceHtml}
                        <span class="text-gray-400 text-sm">${formatDate(article.datetime)}</span>
                    </div>
                    <h2 class="text-xl font-bold text-white mb-3 leading-tight hover:text-primary-400 transition-colors">
                        ${article.headline || 'No headline available'}
                    </h2>
                    <p class="text-gray-300 mb-4 leading-relaxed">
                        ${truncateText(article.summary)}
                    </p>
                    ${article.url ? `
                        <a href="${article.url}" 
                           target="_blank" 
                           rel="noopener noreferrer"
                           class="inline-flex items-center text-primary-400 hover:text-primary-300 font-medium transition-colors">
                            Read Full Article
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </a>
                    ` : ''}
                </article>
            `;
        }

        // Fetch news from API
        async function fetchNews(symbol = null) {
            try {
                showState(loadingState);
                
                let url = '/api/news';
                if (symbol) {
                    url += `?symbol=${encodeURIComponent(symbol)}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status !== 'ok') {
                    throw new Error('API returned error status');
                }
                
                if (!data.articles || data.articles.length === 0) {
                    showState(emptyState);
                    return;
                }
                
                // Display news articles
                newsContainer.innerHTML = data.articles.map(createNewsArticle).join('');
                showState(newsContainer);
                
            } catch (error) {
                console.error('Error fetching news:', error);
                errorMessage.textContent = `Failed to load news: ${error.message}`;
                showState(errorState);
            }
        }

        // Event listeners
        filterBtn.addEventListener('click', () => {
            const symbol = symbolFilter.value.trim().toUpperCase();
            currentSymbol = symbol || null;
            fetchNews(currentSymbol);
        });

        clearFilterBtn.addEventListener('click', () => {
            symbolFilter.value = '';
            currentSymbol = null;
            fetchNews();
        });

        refreshBtn.addEventListener('click', () => {
            fetchNews(currentSymbol);
        });

        // Allow Enter key to filter
        symbolFilter.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                filterBtn.click();
            }
        });

        // Load news when page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchNews();
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            fetchNews(currentSymbol);
        }, 300000); // 5 minutes
    </script>
</body>
</html>